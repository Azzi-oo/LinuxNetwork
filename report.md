## Part 1. Инструмент ipcalc
1. Сети и маски
    - Чтобы определить адрес сети, нужно установить утилиту ipcalc при помощи: sudo apt install ipcalc
    - И определяем адрес сети
    ![ver_linux](screenshots/pic1.png)
2. Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную
    - При помощи команды определим адрес сети ipcalc 255.255.255.0
    ![ver_linux](screenshots/pic2.png)
    - Двоичная запись - 11111111.11111111.11111111.00000000
    - Префиксная запись - /24
    - Воспользуемся командой ipcalc /15
    ![ver_linux](screenshots/pic3.png)
    - Обычная запись - 255.254.0.0 
    - Двоичная запись - 11111111.11111110.00000000.00000000
    - Количество единичек в маске 11111111.11111111.11111111.11110000 - 28шт. Воспользуемся командой ipcalc 1.1.1.1/28
    ![ver_linux](screenshots/pic4.png)
    - Обычная запись - 255.255.255.240
    - Префиксная запись - /28
3.  Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
    - Чтобы определить минимальный и максимальный хост для макси /8 используем команду: ipcalc 12.167.38.4/8
    ![ver_linux](screenshots/pic5.png)
    - минимальный хост - 12.0.0.1 
    - максимальный хост - 12.255.255.254

    - Воспользуемся командой : ipcalc 12.167.38.4/16(т.к 16 единичек)
    ![ver_linux](screenshots/pic6.png)
    - минимальный хост - 12.167.0.1
    - максимальный хост - 12.167.255.254
    
    - Воспользуемся командой: ipcalc 12.167.38.4/23
    ![ver_linux](screenshots/pic7.png)
    - минимальный хост - 12.167.38.1
    - максимальный хост - 12.167.39.254

    - И для последнего: ipcalc 12.167.38.4/4
    ![ver_linux](screenshots/pic8.png)
    - минимальный хост - 0.0.0.1
    - максимальный хост - 15.255.255.254

1.2.localhost
- Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

- 194.34.23.100 - нельзя, т.к это внешний IP и не проходит пинг
    ![ver_linux](screenshots/pic10.png)
- 127.0.0.2 - можно, т.к это адрес указывает на устройство
- 127.1.0.1 - можно
- 128.0.0.1 - нельзя, т.к это уже внешний IP
    
1.3.Диапазоны и сегменты сетей

Определи и запиши в отчёт:
1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
    - узнаем через команду ipcalc
    - 10.0.0.45/8 - частный
    - 134.43.0.2/16 - публичный
    - 192.168.4.2/16 - частный
    - 172.20.250.4/12 - частный
    - 172.0.2.1/12 - публичный
    - 192.172.0.1/12 - публичный
    - 172.68.0.2/12 - публичный
    - 172.16.255.255/8 - частный
    - 10.10.10.10/8 - частный
    - 192.169.168.1/16 - публичный

2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
    - 10.10.0.2
    - 10.10.10.10
    - 10.10.1.255
    - эти адреса возможны, поскольку они соответствуют стандартным диапазонам для частных IP.

## Part 2.Статическая маршрутизация между двумя машинами
Поднять две виртуальные машины (далее -- ws1 и ws2)
![ver_linux](screenshots/pic115.png)
- Чтобы посмотреть сетевые интерфейсы нужна команда: ip a
    - для ws1
    ![ver_linux](screenshots/pic13.png)
    - для ws2
    ![ver_linux](screenshots/pic14.png)

- Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12.
    - ws1 - 192.168.100.10, маска /16
    - ws2 - 172.24.116.8, маска /12
    - На обеих машинах выполняем команду sudo nano /etc/netplan/00-installer-config.yaml и вносим изменения.
    - до внесения изменений:
    - ws1
    ![ver_linux](screenshots/pic15.png)
    - ws2
    ![ver_linux](screenshots/pic16.png)
    - Выполнить команду sudo netplan apply и sudo netplan try для перезапуска сервиса сети
    - ws1
    - ws2
    - При помощи команды ip a проверяем применились ли настройки
    - ws1
    ![ver_linux](screenshots/pic17.png)
    - ws2
    ![ver_linux](screenshots/pic18.png)
2.1. Добавление статического маршрута вручную
    - добавим статический маршрут при помощи команды: ip r add
    - ws1: sudo ip r add и пропинговал соединение: ping 172.24.116.8
    ![ver_linux](screenshots/pic26.png)
    - ws2 и пропинговал соединение: 192.168.100.10
    ![ver_linux](screenshots/pic27.png)
2.2. Добавление статического маршрута с сохранением
Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml.
    - ws1
    ![ver_linux](screenshots/pic28.png)
    - ws2
    ![ver_linux](screenshots/pic23.png)
    - пропинговываю оба соединения на машинах
    - ws1
    ![ver_linux](screenshots/pic31.png)
    - ws2
    ![ver_linux](screenshots/pic32.png)
## Part 3. Утилита iperf3
1. Скорость соединения
Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

    - 8 Mbps = 1 MB/s
    - 100 MB/s = 819200 Kbps
    - 1 Gbps = 1024 Mbps
2. Утилита iperf3

Измерить скорость соединения между ws1 и ws2.
- для измерения скорости нужно присвоить ws1 роль клиента, а ws2 роль сервера
- ws1: iperf3 -c 172.24.116.8
![ver_linux](screenshots/pic116.png)
- ws2: iperf3 -s
![ver_linux](screenshots/pic118.png)

## Part 4. Сетевой экран
1. Утилита iptables
    - Создай файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2
    - ws1
    ![ver_linux](screenshots/pic37.png)
    ![ver_linux](screenshots/pic38.png)
    - ws2
    ![ver_linux](screenshots/pic39.png)
    ![ver_linux](screenshots/pic40.png)
    Входящие пакеты с портов 22 и 80 по протоколу tcp разрешены
    - iptables - название утилиты
    - -A - указывает на добавление (Append) правила в цепочку INPUT
    - -p, протокол - определяет протокол транспортного уровня
    - ACCEPT - пропускает пакет
    - DROP - блокирует пакет
    - --icmp-type - определяет тип ICMP пакета
    - echo-reply - эхо-ответ
    - чтобы запустить правило, которое мы написали в фаерволе запустим команду: sudo chmod +x /etc/firewall.sh
    - ws1
    ![ver_linux](screenshots/pic41.png)
    - ws2
    ![ver_linux](screenshots/pic42.png)
    - правило которое я написал первым выполнится первым DROP, так как читается сверху вниз
    - ws1 проявляется запрещающее правило, так как drop выше
    - ws2 проявляет разрешающее правило
2.  Утилита nmap
    - Командой ping найди машину, которая не «пингуется», после чего утилитой nmap покажи, что хост машины запущен.
    ![ver_linux](screenshots/pic43.png)
    - пропинговал ws1 с ws2
    ![ver_linux](screenshots/pic44.png)
    - запустим утилиту nmap
    - для ws1
    ![ver_linux](screenshots/pic45.png)
    - для ws2
    ![ver_linux](screenshots/pic46.png)

## Part 5. Статическая маршрутизация сети
![ver_linux](screenshots/pic47.png)
1. Настройка адресов машин
- в виртуальной машине поднимаем 5 машин
- в каждой виртуальной машине меняем настройки на:
![ver_linux](screenshots/pic48.png)
- в роутере r1 и r2 еще и Adapter 3 включаем внутреннюю сеть
![ver_linux](screenshots/pic49.png)
- дальше вносим изменение в etc/netplan/00-installer-config.yaml и применим эти изменения при помощи sudo netplan apply
![ver_linux](screenshots/pic51.png)
![ver_linux](screenshots/pic52.png)
![ver_linux](screenshots/pic53.png)
![ver_linux](screenshots/pic54.png)
![ver_linux](screenshots/pic55.png)
- чтобы проверить настройки сети используем команду: ip -4 a
![ver_linux](screenshots/pic56.png)
![ver_linux](screenshots/pic57.png)
![ver_linux](screenshots/pic58.png)
![ver_linux](screenshots/pic59.png)
- ws22 с ws21, аналогично пропингуй r1 с ws11
- ping -c 10 10.20.0.20
![ver_linux](screenshots/pic61.png)
- ping -c 5 10.10.0.1
![ver_linux](screenshots/pic60.png)
2. Включение переадресации IP-адресов
    - Для включения переадресации IP, выполни команду на роутерах:
sysctl -w net.ipv4.ip_forward=1
![ver_linux](screenshots/pic62.png)
![ver_linux](screenshots/pic63.png)
    - Открой файл /etc/sysctl.conf и добавь в него следующую строку
    ![ver_linux](screenshots/pic64.png)
    ![ver_linux](screenshots/pic65.png)
3. Установка маршрута по-умолчанию
    - Настрой маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавь default перед IP роутера в файле конфигураций.
    - ws11
    ![ver_linux](screenshots/pic66.png)
    - ws21
    ![ver_linux](screenshots/pic67.png)
    - ws22
    ![ver_linux](screenshots/pic68.png)
    - Вызови ip r и покажи, что добавился маршрут в таблицу маршрутизации
    ![ver_linux](screenshots/pic69.png)
    ![ver_linux](screenshots/pic70.png)
    ![ver_linux](screenshots/pic71.png)
    - Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит
    ![ver_linux](screenshots/pic72.png)
    ![ver_linux](screenshots/pic73.png)
4. Добавление статических маршрутов
    - Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций
    ![ver_linux](screenshots/pic74.png)
    ![ver_linux](screenshots/pic75.png)
    - Вызови ip r и покажи таблицы с маршрутами на обоих роутерах
    ![ver_linux](screenshots/pic76.png)
    ![ver_linux](screenshots/pic77.png)
    - Запусти команды на ws11
    ![ver_linux](screenshots/pic81.png)
    ![ver_linux](screenshots/pic78.png)
    - Был выбран другой маршрут, отличный от 0.0.0.0/0 для сети 10.10.0.0/18, так как маршрутизатор выбирает маршрут с  "с самой длинной маской", так как это более точное решение. Если следовать этому правилу, то маршрут никогда не будет выбран
5. Построение списка маршрутизаторов
    - Запусти на r1 команду дампа
    - -t Не отображает метку времени в каждой строке.
    - -n Отображает IP-адрес вместо имени хоста.
    - -v Вывод подробной информации (TTL; ID; общая длина заголовка, а также его параметры; производит проверку контрольных сумм IP и ICMP-заголовков)
    - -i Указывает на то, какой сетевой интерфейс будет использоваться для захвата пакетов. (в нашем случае -i enp0s8)
    ![ver_linux](screenshots/pic80.png)
    - Каждый пакет имеет ограниченное количество промежуточных узлов, которые он может проходить на своем пути к конечной точке. Это кол-во определяется значением TTL в заголовке пакета. Каждый промежуточный маршрутизатор через который проходит пакет - уменьшает значение TTL на один. Когда TTL = 0, пакет уничтожается и клиенту возврщается сообщение Time Exceeded которое указывает что пакет превысил время своей жизни.
    Команда traceout в Linux использует UDP пакеты. Она отправляет пакет с TTL = 1 и наблюдает за адресом узла который отвечает. Затем повторяет процесс с увеличением значения TTL до достижения цели.
    Для каждого TTL-запроса traceout отправляет 3 пакета и измеряет время, нужное для прочтения пакетов. Пакеты отправляются на случайный порт, который не занят другими процессами. 
    Когда traceout получает сообщение от целевого узла о недоступности порта, это говорит о завершении трассировки.
6. Использование протокола ICMP при маршрутизации
    - Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды
    - Пропингуй с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды
    ![ver_linux](screenshots/pic82.png)

## Part 6. Динамическая настройка IP с помощью DHCP
- Скачаем isc-dhcp-server командой sudo apt install isc-dhcp-server
    ![ver_linux](screenshots/pic83.png)
1. Настроим конфигурацию службы DHCP в файле /etc/dhcp/dhcpd.conf с помощью команды sudo nano /etc/dhcp/dhcpd.conf на машине r2. Укажем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети
![ver_linux](screenshots/pic84.png)
2. В файле resolv.conf пропишем nameserver 8.8.8.8 с помощью команды sudo nano /etc/resolv.conf на машине r2
![ver_linux](screenshots/pic85.png)
3. Перезагрузим службу DHCP с помощью команды **systemctl restart isc-dhcp-server** на машине r2
- Перезагрузим машину ws21 с помощью команды sudo reboot и с помощью команды ip a покажем, что она получила адрес
![ver_linux](screenshots/pic86.png)
- пропингуем ws22 c ws21
![ver_linux](screenshots/pic87.png)
4. Укажи MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true
![ver_linux](screenshots/pic88.png)

5. Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты
    - ![ver_linux](screenshots/pic89.png)
    - В файле resolv.conf пропишем nameserver 8.8.8.8 с помощью команды sudo nano /etc/resolv.conf на машине r1
    ![ver_linux](screenshots/pic90.png)
    ![ver_linux](screenshots/pic91.png)
    - меняем MAC адрес
    ![ver_linux](screenshots/pic93.png)
    - после того как поменял ![ver_linux](screenshots/pic92.png)
6. Запроси с ws21 обновление ip адреса
    - до обновления
    ![ver_linux](screenshots/pic94.png)
    - после обновления
    ![ver_linux](screenshots/pic119.png)

## Part 7. NAT

1. В файле /etc/apache2/ports.conf на ws22 и r1 измени строку Listen 80 на Listen 0.0.0.0:80, то есть сделай сервер Apache2 общедоступным
    - для этого скачаем на обе машины isc-dhcp-server с командой: sudo apt install apache2.
    - ws22
    ![ver_linux](screenshots/pic95.png)
    - r1
    ![ver_linux](screenshots/pic96.png)
2. Запусти веб-сервер Apache командой service apache2 start на ws22 и r1
![ver_linux](screenshots/pic97.png)
![ver_linux](screenshots/pic98.png)
3. Добавь в фаервол, созданный по аналогии с фаерволом из Части 4
    - для начала нужно создать файл /etc/firewall.sh
    ![ver_linux](screenshots/pic99.png)
    - 1) Удаление правил в таблице filter - iptables -F;

    - 2) Удаление правил в таблице "NAT" - iptables -F -t nat;

    - 3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP.
    - Добавление этих правил
    ![ver_linux](screenshots/pic100.png)
    - чтобы запустить файл применим команду sudo chmod +x и sudo /etc/firewall.sh
    ![ver_linux](screenshots/pic101.png)
    - пропингуем ws22 с r1
    ![ver_linux](screenshots/pic102.png)
4. Разрешить маршрутизацию всех пакетов протокола ICMP.
    - для этого подправим файл firewall.sh на машине r2 добавив строчку
    ![ver_linux](screenshots/pic103.png)
    - применяю эти правила при помощи команд: sudo chmod +x /etc/firewall.sh и sudo /etc/firewall.sh
    - Проверь соединение между ws22 и r1 командой ping

5. Включи SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
    - SNAT, Используется только в цепочке POSTROUTING таблицы nat . Изменяет адрес источника пакета, если он удовлетворяет условиям, и всех последующих пакетов соединения (последние не будут тестироваться).

    - -t, --table таблица nat: Эта таблица используется, когда встречается пакет, устанавливающий новое соединение. Она содержит три предопределённых цепочки: PREROUTING (для изменения входящих пакетов), OUTPUT (для изменения локально сгенерированных пакетов перед их отправлением) и POSTROUTING (для изменения всех исходящих пакетов).

    - -o, --out-interface [!] имя Имя интерфейса, через который отправляется обрабатываемый пакет (только для пакетов входящих в цепочки FORWARD, OUTPUT и POSTROUTING ).

    - -s, --source [!] адрес[/маска] Адрес источника. Адресом может быть сетевое имя, имя хоста (не рекомендуем указывать имена хостов, разрешаемые через запросы к удалённым DNS), диапазон IP-адресов (с маской через слэш) или одиночный IP-адрес.

    - --to-source ip1[-ip2][:порт1-порт2] IP-адрес или диапазон адресов (включительно) источника, а также (необязательно, и только в случае -p tcp или -p udp) диапазон портов. Если последний не указан, то выполняются следующие отображения: порты до 512 будут отображаться в порты до 512; порты от 512 до 1023 включительно
    - в порты до 1024; остальные - в порты начиная с 1024. По возможности порты будут отображаться сами в себя.

6. Включи DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
    - для этого в машине r2 добавим строку
    ![ver_linux](screenshots/pic104.png)
    - DNAT - применяется только в таблице nat и в цепочках PREROUTING, OUTPUT и вызываемых из них цепочках определяемых пользователем. 
    - проверка для соединения TCP для SNAT, для этого с ws22 подключимся к серверу Apache на r1 при помощи команды:
    - проверка соединения по TCP для SNAT для этого с ws22 подключимся к серверу на r1: telnet 10.100.0.11 80
    ![ver_linux](screenshots/pic107.png)
    - проверка соединения по TCP для DNAT для этого подключимся к серверу на ws22 при помощи команды: telnet 10.100.0.12 80
    ![ver_linux](screenshots/pic106.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels
1. Запусти веб-сервер Apache на ws22 только на localhost
    - на машине ws22 откроем файл /etc/apache2/ports.conf при помощи sudo nano /etc/apache2/ports.conf
    и изменим на Listen localhost:80
    ![ver_linux](screenshots/pic108.png)
    - и запустим сервер Apache
    ![ver_linux](screenshots/pic109.png)
2. Воспользуйся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
    - Для Local TCP forwarding применяется команда ssh -L local_port:destination:destination_port ssh_server_ip. -L указывает, что соединения с заданным TCP-портом или сокетом Unix на локальном (клиентском) хосте должны перенаправляться на заданный хост и порт или сокет Unix на удаленной стороне.
    - на машине ws21 получим доступ к серверу ws22 при помощи ssh -L 8080:localhost:80 10.20.0.20
    ![ver_linux](screenshots/pic110.png)
    - на машине ws21 проверим подключение при помощи telnet 127.0.0.1 80
    ![ver_linux](screenshots/pic111.png)
3. Воспользуйся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.
    - на машине ws22 получим доступ к серверу ws11
    ![ver_linux](screenshots/pic114.png)
    - на машине ws11 проверим подключение
    ![ver_linux](screenshots/pic113.png)
